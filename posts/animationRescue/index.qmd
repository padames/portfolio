---
title: "Animation to explain coupled time-series"
author: "Pablo Adames"
date: "2024-12-15"
categories: [Visualization, R, ggplot2]
---

I consider Edward E. Tufte one of the modern experts in data visualization. I attended one of his talks in Seattle in May 2019. All attendees walked away with a beautiful set of his most important books while I left with the challenge of stuffing the set in my carry-on bag on the flight back to Calgary that night.

Aside from the pleasant experience and the wonderful books I bring this up because there are two kinds of data visualization examples he introduces at the beginning of his book, "The Visual Display of Quantitative Information": data maps and time series. Visual excellence, Tufte claims in his book, is achieved when one can convey an idea in the shortest time using the least amount of ink and printed space to an observer. This implies cramming the most information possible with the least use of resources without obscuring meaning or confusing the main idea.

One of the time-series examples is a facet grid plot representing the evolution of unemployment rate and inflation in several countries. The term facet grid, of course is adopted from ggplot lingo.

![](thumbnail.jpg)

```{r loading-ggplot2, echo=FALSE, attr.warning=FALSE, message=FALSE}
## functional and vectorized single function from 
## https://stackoverflow.com/a/44660688/1585486

using<-function(...) {
  libs <- unlist(list(...))
  req  <- unlist(lapply(libs, require, character.only = TRUE))
  need <- libs[req == FALSE]
  if(length(need) > 0){ 
    install.packages(need)
    lapply(need, require,character.only = TRUE)
  }
}

using("ggplot2", "here", "plotly")
```

## The problem statement

One of the examples used in Hadley Wickham's book, "ggplot2 - Elegant Grahics for Data Analysis", has also to do with the representing how two economic variables related to unemployment in the USA behave over the years. The current computational resources available to us have made it relatively easy to address these visualization challenges to achieve visual excellence.

This blog post is about the way we can add a third dimension to a 2-D plot using animation to explore the evolution of two related time-series.

Individual time dependent variables are easily visualized by drawing their time series representation on a two-dimensional plot. The difficulty becomes visualizing two time series in the same traditional graph. One elegant solution was mentioned in Tufte's book mentioned in the introduction to this post. Let's use animation to add more insight into the data.

## The `economics` data set

These examples are re-used from section 2.6.5 of <https://ggplot2-book.org/getting-started#sec-line>.

The data set called `economics` from the ggplot2 package, has employment statistics on the US measured over the last 40 years up until 2015.

Here is a brief look at the first 5 out of `r nrow(economics)` rows of the dataframe `economics`.

```{r data-frame-economics, echo=TRUE}
data <- head(economics, n=5)
knitr::kable(data)
```

## Visualizing the Unemployment Rate

Let's first make a simple time series plot of the unemployment rate. This is a continuous variable that is computed with the ratio `unemploy/pop`.

In ggplot2 a frame defines the first mapping from variables to a space where the data will be represented. It is created with the function `aes()`. The obvious frame for this plot is defined by the two variables `date` and `unemploy / pop`. They are mapped to the x and y coordinates of a 2-D plane. The glyphs drawn over this frame will be lines between the data points located in the frame, they are created with the function `geom_line()`. This function defines a layer over the frame.

```{r running-separate-time-series-unemployment-rate, echo=TRUE}
ggplot(data = economics, mapping = aes(x = date, y = unemploy / pop)) +
  geom_line()
```

Technically speaking `unemploy / pop` represents the *"population rate of unemployment as a fraction of the population able to work that is unemployed"*, (<https://www.bls.gov/cps/cps_htgm.htm#definitions>)

## Visualizing the unemployment median duration in weeks

Another variable called `uempmed` from the same dataset tracks the median length of time in weeks of unemployment.

```{r running-separate-time-series-mean-time, echo=TRUE}
ggplot(economics, aes(date, uempmed)) +
  geom_line()
```

From these two plots one can observe the recent trend towards longer median unemployment time in the decade of 2010. There are also cycles of between 5 and 10 years of peak unemployment rates.

An interesting question is how these two time series correlate over time. Are there interactions between these two variables that we could observe in one plot?

## Visualizing both variables in the same plot

In ggplot2, the frame for a representation that shows both variables on an line plot can be defined by a mapping of each variable to the x and y coordinates of the plane. We can create two types of glyphs over it: one is points shown by a layer defined by `geom_point` to show the location of the variables at a point in time. The other type of glyph is lines to show the sequential trajectory, ordered by time, from one point to the next. This is captured by the layer `geom_path`. The figure below shows such a graph.

```{r path-plot-first-attempt}
ggplot(economics, aes(unemploy / pop, uempmed)) + 
  geom_path() +
  geom_point()
```

It is hard to understand the direction of time from the lines alone. For example, it is difficult to visualize where the first, the last, or any years in between have happened.

This can be addressed by adding a mapping from the property colour to the variable year in the layer `geom_point`. R uses a default colour scale to assign specific colours from a colour palette to years.\
The ggplot2 package defines the function `aes()` to create this many to many mapping.

```{r path-plot-time-direction-encoded-to-colour}
year <- function(x) as.POSIXlt(x)$year + 1900
ggplot(economics, aes(unemploy / pop, uempmed)) + 
  geom_path(colour = "grey50") +
  geom_point(aes(colour = year(date)))
```

The layer `geom_path` has a mapping from each line created between points to the same colour value indicated by the specification *"grey50"*. The syntax does not require the use of the `aes()` function. It is a many to one mapping.

This plot is a good attempt at representing the time dimension with a varying shade of colour. This is unsatisfactory because the lines get too tangled, making the direction of time unclear. This looks eerily similar to the example Tufte refers to in his book, the difference is that we don't print years near some of the dots. Instead we chose to use the shade of blue in the points as a way to convey information about the year. 

## Animation to the rescue

We can get a more sophisticated visualization by using animation to explain how the two variables change simultaneously as time passes. In the following plot, the values of unemployment rate and median unemployment length in weeks are displayed for every year. By pressing the PLAY button, one sees the points for each year over the line trajectory, from beginning to end. One can use the slider to visualize the position of the variables for any given year.

```{r annimation, echo=TRUE, warning=FALSE}
library(plotly)
year <- function(x) as.POSIXlt(x)$year + 1900
p <- ggplot(economics, aes(unemploy / pop, uempmed)) + 
  geom_path(colour = "grey75") +
  geom_point(aes(colour = year(date), frame = year(date)))

fig <- ggplotly(p)

fig <- fig %>% animation_opts(1000,
                              easing = "elastic", 
                              redraw = FALSE )
fig <- fig %>% animation_button(x = 0.05, xanchor = "left",
                                y = 1.1, yanchor = "top")
fig <- fig %>% animation_slider(currentvalue = list(prefix = "YEAR ",
                                                    font = list(color="red")))
fig
```

From watching the motion of the annual data after pressing the Play button, one gets the sense that for the first 41 years the values of these two time series remained within the quadrant below the 15 week and to the left of 4% unemployment rate except for the years 1982 and 83. Then after 2009 the median unemployment length in weeks has increased over and above any value of the previous years in the USA according to this dataset.

The animation has achieved the introduction of a new dimension to represent the flow of time over the bi-dimensional plane representing the two time observed variables. In non-digital media the only alternative we would have is representing time progression with other dimensions like point color intensity or perhaps point diameter.
